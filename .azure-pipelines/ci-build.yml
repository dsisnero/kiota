trigger:
  branches:
    include:
      - main
      - azure-pipelines # Ensuring it triggers on your preview branch

  paths:
    include:
      - Dockerfile
      - src/**

pool:
  vmImage: $(vmImageName)

variables:
  REGISTRY: 'msgraphpperegistry.azurecr.io'
  IMAGE_NAME: 'public/openapi/kiota'
  PREVIEW_BRANCH: 'refs/heads/azure-pipelines'
  TAG: '$(Build.BuildId)'

stages:
  - stage: BuildAndPush
    displayName: 'Build and Push Multi-Arch Image'
    jobs:
      - job: BuildAndPush
        displayName: 'Build and Push Docker Image'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Login to Azure using ARM service connection'
            inputs:
              azureSubscription: 'ACR Push Test'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az acr login --name $(REGISTRY)

          - script: |
              docker run --privileged --rm tonistiigi/binfmt --install all
            displayName: 'Enable multi-platform builds'

          - script: |
              docker buildx create --use --name mybuilder
            displayName: 'Set up Docker BuildX'

          - script: |
              docker buildx inspect --bootstrap
            displayName: 'Ensure BuildX is working'

          - script: |
              docker buildx build --platform linux/amd64,linux/arm64 \
                --push \
                -t $(REGISTRY)/$(IMAGE_NAME):$(TAG) \
                -t $(REGISTRY)/$(IMAGE_NAME):latest \
                .
            displayName: 'Build and Push Multi-Platform Image'
